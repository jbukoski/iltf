{% extends 'base.html' %}
{% load static %}

{% block side_bar %}

    <title>{{ title }}</title>

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle btn" data-toggle="collapse" data-target=".navbar-collapse" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i class="fa fa-ellipsis-v" style="color: white"></i></button>
            <button id="toggle" type="button" class="navbar-toggle btn" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i id="toggleIcon" class="fa fa-check-square-o" style="color: white"></i></button>
            <a class="navbar-brand" href="ENTER TRIBE URL" target="_blank_">RENAME</a>
        </div>
        <div class="navbar-collapse collapse" id="navbar-collapse">
            <ul class="nav navbar-nav pull-left">
                <a class="navbar-brand" href="#" style="font-size: 0.75m; color: gray;">Land & Natural Assets Map</a>
            </ul>
            <ul class="nav navbar-nav pull-right">
                <a class="navbar-brand" href="{% url 'signout' %}" style="font-size: 18px; color: grey;">Log Out</a>
            </ul>
        </div>
    </div>

    <div class="row" id="container">
        <div class="col-sm-3 col-lg-3" id="sidebar" style="padding: 10px; overflow: auto;">
            <ul class="nav nav-tabs" id="myTab">
                <li class="active"><a href="#layers" data-toggle="tab"><i class="fa fa-check-square-o"></i>&nbsp;Layers</a></li>
                <li><a href="#upload" data-toggle="tab"><i class="fa fa-upload"></i>&nbsp;Import</a></li>
                <li><a href="#documentation" data-toggle="tab"><i class="fa fa-info-circle"></i>&nbsp;Documentation</a></li>
            </ul>

            <div class="tab-content" style="padding-top: 10px;">
                <div class="tab-pane active" id="layers">
                    <div class="panel-group">

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#admin-layers">
                                    Administrative Layers
                                </a>
                            </div>
                            <div id="admin-layers" class="panel-collapse collapse in">
                                <div class="panel-body" style="padding: 0px 15px;">
				    <div class="checkbox">
				        <label>
                                            <input type="checkbox" name="overlayLayers" id="boundary" z-index="1" checked>
                                            &nbsp; Reservation boundary &nbsp; <a href="{% url 'boundary_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
				</div>
	                    </div>
                        </div> <!--Closes 'panel panel-default for administrative layers'-->

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#hydro-layers">
                                        Hydrology Layers
                                </a>
                            </div>
                            <div id="hydro-layers" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="watersheds" z-index="3">
                                            &nbsp; ENTER HYDROLOGY LAYERS &nbsp; <a href="{% url 'watersheds_dl' %}"><i style="float:right;" class="fa fa-download"></i></a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div> <!--Closes 'panel panel-default for hydrology layers'-->

			<div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#soil-layers">
                                    Soil Characteristics Layers
                                </a>
                            </div>
                            <div id="soil-layers" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
			    	<div class="checkbox">
			                <label>
                                            <input type="checkbox" name="overlayLayers" id="bulkDens" z-index="3">
                                            &nbsp; Bulk density &nbsp; <a href="{% url 'bulk_dens_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="composting" z-index="3">
                                            &nbsp; Composting cover &nbsp; <a href="{% url 'compost_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="org_matter" z-index="3">
                                            &nbsp; Organic matter &nbsp; <a href="{% url 'om_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="soil_ph" z-index="3">
                                            &nbsp; Surface pH, weighted average &nbsp; <a href="{% url 'ph_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="taxonomy" z-index="3">
                                            &nbsp; Taxonomic classification &nbsp; <a href="{% url 'tax_cl_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="texture" z-index="3">
                                            &nbsp; Texture &nbsp; <a href="{% url 'texture_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                    </div>
            		        </div>
            		    </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#vegetation-layers">
                                    Vegetation Layers
                                </a>
                            </div>
                            <div id="vegetation-layers" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                   <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="landfireEVT" z-index="3">
                                            &nbsp; LANDFIRE Vegetation Type &nbsp; <a href="{% url 'landfire_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                   </div>
                                   <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="ndvi2005" z-index="3">
                                            &nbsp; Mean Annual NDVI - 2005 &nbsp; <a href="{% url 'ndvi_2005_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                   </div>
                                   <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="ndvi2010" z-index="3">
                                            &nbsp; Mean Annual NDVI - 2010 &nbsp; <a href="{% url 'ndvi_2010_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                   </div>
                                   <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="ndvi2015" z-index="3">
                                            &nbsp; Mean Annual NDVI - 2015 &nbsp; <a href="{% url 'ndvi_2015_dl' %}"><i style="float:right;" class = "fa fa-download"></i></a>
                                        </label>
                                   </div>
                                </div>
                            </div>
                        </div>

			<div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#carbon-layers">
                                    Carbon Layers
                                </a>
                            </div>
                            <div id="carbon-layers" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="agc" z-index="3">
                                            &nbsp; Forest aboveground carbon &nbsp; <a href="{% url 'agc_dl' %}"><i style="float:right;" class="fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="overlayLayers" id="bgc" z-index="3">
                                            &nbsp; Forest belowground carbon &nbsp; <a href="{% url 'bgc_dl' %}"><i style="float:right;" class="fa fa-download"></i></a>
                                        </label>
                                    </div>
                                    <div class="checkbox">
			    	    <label>
                                            <input type="checkbox" name="overlayLayers" id="gssurgoSOC" z-index="3">
                                            &nbsp; Soil organic carbon &nbsp; <a href="{% url 'soc_dl' %}"><i style="float:right;" class="fa fa-download"></i></a>
                                        </label>
                                    </div>
            		        </div>
            		    </div>
                        </div>


                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#user-layers">
                                        User-defined Layers
                                </a>
                            </div>
                            <div id="user-layers" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <!-- List of uploaded documents -->
                                    {% if documents %}
                                        {% for document in documents %}
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" name="uploadLayers" id="{{ document.docfile.name }}" z-index="5" value="{{ document.docfile.name }}" onclick="show_static('{{ document.docfile.name }}')">
                                                        <div style="display: inline-block;">
                                                            {{ document.name }}
                                                        </div>
                                                    </input>
                                                </label>
                                                <div style="display: inline-block; float:right;">
                                                <form role="form" method="POST" action="{% url 'delete_single' %}" enctype="multipart/form-data" style="display: inline-block;">
                                                    {% csrf_token %}
                                                    <input name="dat" value={{ document.docfile }} style="display: none;">
                                                        <button class="fa fa-trash-o" type="submit" style="color: red; border: none; background: none;"></button>
                                                    </input>
                                                </form>
                                                <form role="form" method="POST" action="{% url 'download_single' %}" enctype="multipart/form-data" style="display: inline-block;">
                                                    {% csrf_token %}
                                                    <input name="dl_file" value={{ document.docfile }} style="display: none;">
                                                        <button class="fa fa-download" type="submit" style="color: #428BCA; border: none; background: none;"></button>
                                                    </input>
                                                </form>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <p style="padding: 15px 0px 0px 0px;"><i>No documents uploaded.</i></p>
                                    {% endif %}
                                </div>
                            </div>
        	        </div> <!--Closes 'panel panel-default'-->

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#imagery">
                                        Base Layers
                                </a>
                            </div>
                            <div id="imagery" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                		    <div class="radio">
                		        <label>
                                            <input type="radio" name="basemapLayers" id="esriWorld" checked>
                                                &nbsp; World Imagery, ESRI
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="basemapLayers" id="topo">
                                                &nbsp; Topography, ESRI
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="basemapLayers" id="osmBaseMap">
                                                &nbsp; Open Street Map
                                        </label>
                                    </div>
            		        </div>
        	            </div>
                        </div> <!-- closes 'Base Layers' panel -->

            	        <br>
                    </div>  <!--Closes 'panel group'-->
                </div> <!--Closes 'layers' panel-->

                <div class="tab-pane" id="upload">
                    <div class="row">
                        <div class="col-md-12">
                            <h4><b>Upload Data Layers:</b></h4>
                            </br>
                            <p> New data layers in GeoJSON format (<b>.geojson</b>) and in a <b>EPSG:4326</b> projection may be uploaded to this webmap and used along with existing data for interactivity and visualizations.</p>
                            <div style="height: 20px;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <h4>Upload local <i>.geojson</i> file:</h4>
                            <form role="form" method="POST" action="{% url 'sample_up' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="file" name="docfile" onchange="uploader()" id="upload_file">
                                <div style="height: 15px;"></div>
                                <div id="show_upload" style="padding-bottom: 15px;"></div>
                                <button id="send_upload" class="btn btn-danger" style="display: none" type="submit">Upload File</button>
                            </form>
                            <div style="height: 20px;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <h4>Delete Uploaded GeoJSON:</h4>
                            <p>Delete <strong>all</strong> previously uploaded GeoJSON files from the server. <i>Please note that this action cannot be undone.</i></p>
                            <form role="form" method="POST" action="{% url 'delete_up' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input name="del_files" type="file" id="del_files" value="{{ request.path }}" style="display: none;">
                                <button id="del_uploads" class="btn btn-info" type="submit">Delete Files</button>
                            </form>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>
                </div> <!--Closes tab-pane="upload"-->

                <div class="tab-pane" id="documentation">
                    <div class="panel-group">

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#overview">
                                    Webmap Overview
                                </a>
                            </div>
                            <div id="overview" class="panel-collapse collapse in">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> This webmap is a collaborative product between the <a href="ENTER TRIBE URL HERE" target="_blank">ENTER TRIBE NAME HERE</a>, the <a href="https://iltf.org/" target="_blank">Indian Land Tenure Foundation</a> and the <a href="http://sig-nal.org/" target="_blank">Spatial Informatics Group Natural Assets Laboratory (SIG-NAL)</a>. </p>
                                        <p> The webmap compiles TRIBE NAME HERE data layers with publically available environmental raster layers and several functions designed to facilitate environmental decision-making within the TRIBE NAME's jurisdiction.</p>
                                        <p> For more information on the various data layers and webmap functions provided, expand the tabs below.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-overview">
                                    Data Layers Overview
                                </a>
                            </div>
                            <div id="data-layers-overview" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The data layers hosted on this webmap are a combination of layers provided by the Pueblo and publically accessible environmental data layers. Additional information on the layers metadata and sources are provided in the Data Layers tabs below. </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-admin" style="padding: 0px 0px 0px 15px;">
                                    <i>Data Layers: Administrative</i>
                                </a>
                            </div>
                            <div id="data-layers-admin" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>administrative layers</b> hosted on the webmap consist of:
                                              <ul>
                                                 <li> <i>Reservation boundary</i> </li>
                                                 <li> <i>Master business leases</i> </li>
                                                 <li> <i>Reservation roads</i> </li>
                                              </ul>
                                              <p>The administrative layers are provided by the Pueblo. The layers provide the approximate reservation boundary, polygons representing five master business leases within the boundary, and a database of roads. The master business leases and roads layers can be queried for additional information.</p>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-hydro" style="padding: 0px 0px 0px 15px;">
                                    <i>Data Layers: Hydrology</i>
                                </a>
                            </div>
                            <div id="data-layers-hydro" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>hydrology layers</b> hosted on the webmap consist of:
                                              <ul>
                                                 <li> <i>Watersheds</i> </li>
                                                 <li> <i>Subwatersheds</i> </li>
                                                 <li> <i>Surface hydrology</i> </li>
                                              </ul>
                                              <p>The hydrology layers are provided by the Pueblo and represent the geographic boundaries of watersheds, subwatersheds, and surface hydrology for the region. The watershed and subwatershed layers can be queried for additional information.</p>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-soil" style="padding: 0px 0px 0px 15px;">
                                    <i>Data Layers: Soil Characteristics</i>
                                </a>
                            </div>
                            <div id="data-layers-soil" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>soil characteristics layers</b> hosted on the webmap consist of:
                                              <ul>
                                                 <li> <i>Soil bulk density</i> </li>
                                                 <li> <i>Composting cover</i> </li>
                                                 <li> <i>Organic matter</i> </li>
                                                 <li> <i>Surface pH, weighted average</i> </li>
                                                 <li> <i>Taxonomic classification</i> </li>
                                                 <li> <i>Texture</i> </li>
                                              </ul>
                                              <p>The soil characteristics layers provide key soil characteristics data for managing landscapes. The soil characteristics data are provided for distinct sampling units that as identified by the National Cooperative Soil Survey. The data is provided by the Soil Survey Geographic database (SSURGO). More information on the soil characteristics layers can be found <a href="https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_053627">here</a>.</p>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-vegetation" style="padding: 0px 0px 0px 15px;">
                                    <i>Data Layers: Vegetation</i>
                                </a>
                            </div>
                            <div id="data-layers-vegetation" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>vegetation layers</b> hosted on the webmap consist of:
                                              <ul>
                                                 <li> <i>LANDFIRE Existing Vegetation Type</i> </li>
                                                 <li> <i>Mean Annual NDVI for three different years</i> </li>
                                              </ul>
                                              <p>The <b>LANDFIRE Existing Vegetation Type</b> is a product of the United States Geological Survey that provides the existing vegetation type on the landscape for 2014. More information on LANDFIRE EVT can be found <a href="https://www.landfire.gov/NationalProductDescriptions21.php">here</a>.</p>
                                              <p>The <b>mean annual Normalized Difference Vegetation Index</b> (NDVI) layers provide the mean annual NDVI for 2005, 2010, and 2015 (i.e., the average NDVI value for each pixel in the landscape for the year of interest). NDVI is an indicator of "greenness" in a landscape, and provides a proxy for presence of healthy, green vegetation. More information on NDVI can be found <a href="https://en.wikipedia.org/wiki/Normalized_Difference_Vegetation_Index" target="_blank">here</a>.</p>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#data-layers-carbon" style="padding: 0px 0px 0px 15px;">
                                    <i>Data Layers: Carbon</i>
                                </a>
                            </div>
                            <div id="data-layers-carbon" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>carbon layers</b> hosted on the webmap consist of:
                                              <ul>
                                                 <li> <i>Aboveground forest carbon</i> </li>
                                                 <li> <i>Belowground forest carbon</i> </li>
                                                 <li> <i>Soil organic carbon</i> </li>
                                              </ul>
                                              <p>All of the carbon layers are taken from the United States Department of Agriculture's <a href="www.carbonscapes.org" target="_blank">CarbonScapes</a> Initiative, which seeks to providely publically accessible data on geospatial patterns of terrestrial carbon within the United States.</p>
				              <p>The <b>aboveground forest carbon</b> data layer provides estimates of aboveground biomass carbon (g/cm<sup>3</sup>) gridded at a 250 x 250 m resolution. The data is provided by the USDA Forest Service's Forest Inventory and Analysis, and additional details can be found <a href="http://www.carbonscapes.org/USDA/MapLayerInfo/MapLayerInfo.aspx?id=93">here</a>.</p>
                                              <p>The <b>belowground forest carbon</b> data layer provides estimates of belowground biomass carbon (g/cm<sup>3</sup> gridded at a 250 x 250 m resolution. The data is provided by the USDA Forest Service's Forest Inventory and Analysis, and additional details can be found <a href="http://www.carbonscapes.org/USDA/MapLayerInfo/MapLayerInfo.aspx?id=94">here</a>.</p>
                                              <p>The <b>soil organic carbon</b> provides data on organic carbon (g/cm<sup>3</sup>) from 0 - 100 cm, gridded to a 10 x 10 m resolution. The data is provided by the gridded Soil Survey Geographic Database (gSSURGO), and additional details can be found <a href="http://www.carbonscapes.org/USDA/MapLayerInfo/MapLayerInfo.aspx?id=80">here</a>.</p>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#functions-overview">
                                    Functions Overview
                                </a>
                            </div>
                            <div id="functions-overview" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The webmap's functions are designed to empower its users in environmental decision-making. The primary functions comprise of:</p>
                                        <ul>
                                            <li><i>Layer query</i></li>
                                            <li><i>Layer import</i></li>
                                            <li><i>Raster summary statistics</i></li>
                                        </ul>
                                        <p> The functions are described in greater detail below.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#legend" style="padding: 0px 0px 0px 15px;">
                                    <i>Functions: Layer Query</i>
                                </a>
                            </div>
                            <div id="legend" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The various vector layers hold attribute data that can be accessed by clicking on the polygon or line. In addition, the raster data of the <b>vegetation layers</b> can be queried by turning on each of the layers and clicking on the map. A popup will be returned that displays the information of interest.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#import-doc" style="padding: 0px 0px 0px 15px;">
                                    <i>Functions: Layer Import</i>
                                </a>
                            </div>
                            <div id="import-doc" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>layer import</b> function can be accessed through the <b><i>Import</i></b> tab. To import a vector layer to the webmap, there are two key criteria: </p>
                                        <ol>
                                            <li>The layer must be in <b>.geojson</b> format.</li>
                                            <li>The layer must be in <b>EPSG:4326</b> projection. </li>
                                        </ol>
                                        <p> GeoJSON is a native format for webmapping, as is the EPSG:4326 projection. If files are uploaded, but cannot be displayed on the webmap, it is likely that one of these two criteria is not met. ESRI Shapefiles can be converted to GeoJSON format and EPSG:4326 projection through basic, free and open source GIS software such as <a href="http://www.qgis.org/en/site/" target="_blank">QGIS</a>.</p>
                                        <p> To import a layer, simply select the <b><i>Import</i></b> tab and click on the <b><i>Choose file</i></b> button. Navigate to the GeoJSON file you'd like to upload, and select it. After doing so, basic information about the file will be displayed. Select the red <b><i>Upload file</i></b> button to upload the file. The layer should not be available within the <b><i>User-defined Layers</i></b> section under the <b><i>Layers</i></b> tab.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <a class="accordion-toggle btn-block" data-toggle="collapse" data-parent="#accordion_" href="#sum-stats" style="padding: 0px 0px 0px 15px;">
                                    <i>Functions: Summary Statistics</i>
                                </a>
                            </div>
                            <div id="sum-stats" class="panel-collapse collapse">
                                <div class="panel-body" style="padding: 0px 15px;">
                                    <div style="padding: 15px 5px;">
                                        <p> The <b>summary statistics</b> function provides a means of estimating pools of carbon over select geographic areas within the landscape. In short, the function allows the user to summarize any of the carbon layers within a polygon of interest.</p>
                                        <p> To run the <b>summary statistics</b> function, simply turn on any or all of the <b>carbon layers</b>. Then, use the one of the <b>draw</b> tools (the square and pentagon buttons directly below the image of the printer) to draw a polygon on the map. After the polygon is drawn, click on it and a pop-up will display showing the summary statistics of the selected layer. Note that for large polygons, the summary function may take several seconds to run. </p>
					<p> To select a different polygon, you must either <b>edit</b>, or <b>delete</b> the existing polygon. Click on the pencil icon to <b>edit</b>, or the trashcan icon to <b>delete</b> the polygon (select the trashcan, click the polygon, and then select "save"). You will then be able to <b>draw</b> a new polygon. </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </br>

                    </div> <!-- closes 'panel-group' -->
                </div> <!--Closes tab-pane="documentation"-->

            </div> <!--Closes 'tab-content'-->
        </div> <!--Closes ID="sidebar"-->

        <div class="col-sm-9 col-lg-9" id="map"></div>

        </div> <!--Closes ID="container"-->

{% endblock side_bar %}

{% block layers %}

<script type="text/javascript" href="http://depot.ign.fr/geoportail/api/develop/tech-docs-js/examples/js/geoportalLeaflet.js"></script>
<script type="text/javascript">


///////////////////////////
////// Vector Layers //////
///////////////////////////

    var boundary = new L.GeoJSON.AJAX("{% url 'boundary' %}", {
        style: { clickable: false,
                 weight: 3,
                 color: '#000000',
                 dashArray: 3,
                 opacity: 1,
                 fill: false,
               }
    });

    var buff_bndry = new L.GeoJSON.AJAX("{% url 'buff_bndry' %}", {
        style: {clickable: true,
                opacity: 0,
                fill: true,
                fillOpacity: 0,
                zIndex: -100,
               }
    });

    var roads = new L.GeoJSON.AJAX("{% url 'roads' %}", {
        style: {color: '#ffffff',
                weight: 2,
                dashArray: 1,
                opacity: 1,
                clickable: true,
               },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<strong>Name:&nbsp;</strong>" + feature.properties.name.toString() + "<br>" +
                "<strong>Surface type:&nbsp;</strong>" + feature.properties.surface.toString() + "<br>" +
                "<strong>Condition:&nbsp;</strong>" + feature.properties.condition.toString()
            );
        },
    });

    var ag = new L.GeoJSON.AJAX("{% url 'ag' %}", {
        style: function (feature) { 
                   if (feature.properties.community === "Community Area 1") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#32CD32',
                       };
                   };
                   if (feature.properties.community === "Community Area 2") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#32FAA2',
                       };
                   };
                   if (feature.properties.community === "Community Area 3") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#32C890',
                       };
                   };
                   if (feature.properties.community === "Community Area 4") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#008000',
                       };
                   };
                   if (feature.properties.community === "Private") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#FF337D',
                       };
                   };
               },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<b>Community:&nbsp;</b>" + feature.properties.community.toString() + "&nbsp;&nbsp;&nbsp;&nbsp;<br>" +
                "<b>Tract number:&nbsp;</b>" + feature.properties.tract_numb.toString() + "<br>" +
                "<b>Status:&nbsp;</b>" + feature.properties.status.toString() + "<br>" +
                "<b>Area:&nbsp;</b>" + (feature.properties.acres.toString()*0.404686).toFixed(2) + "&nbsp;ha<br>" +
                "<b>Total soil organic carbon:&nbsp;~</b>" + feature.properties.soctotal.toString() + "&nbsp;Mg<br>" +
                "<b>Mean soil organic carbon:&nbsp;~</b>" + feature.properties.socmean.toString() + "&nbsp;Mg/ha<br>"
            );
        }
    });

    var vineyards = new L.GeoJSON.AJAX("{% url 'vineyards' %}", {
        style: function (feature) { 
                   if (feature.properties.section === "Section 1-West") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#800000',
                       };
                   };
                   if (feature.properties.section === "Section 1-East") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#A20F2E',
                       };
                   };
                   if (feature.properties.section === "Section 2") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#97505F',
                       };
                   };
                   if (feature.properties.section === "Section 3") {
                       return {
                           clickable: true,
                           weight: 2,
                           fillOpacity: 0.3,
                           color: '#F20739',
                       };
                   };
               },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<b>VIneyard:&nbsp;</b>" + feature.properties.section.toString() + "<br>" +
                "<b>Area:&nbsp;</b>" + parseFloat(feature.properties.acres.toString()*0.404686).toFixed(2) + "&nbsp;ha<br>" +
                "<b>Total soil organic carbon:&nbsp;~</b>" + feature.properties.soctotal.toString() + "&nbsp;Mg<br>" +
                "<b>Mean soil organic carbon:&nbsp;~</b>" + feature.properties.socmean.toString() + "&nbsp;Mg/ha<br>"
            );
        }
    });



    var mbls=new L.GeoJSON.AJAX("{% url 'mbls' %}", {
        style: function (feature) {
                    if (feature.properties.entity === "Hyatt Tamaya") {
                        return {
                            clickable: true,
                            weight: 2,
                            color: '#4FE11E',
                            fill: true,
                            fillOpacity: 0.5,
                        };
                    };
                    if (feature.properties.entity === "Prairie Star") {
                        return {
                            clickable: true,
                            weight: 2,
                            color: '#e8f73e',
                            fill: true,
                            fillOpacity: 0.5,
                        };
                    };
                    if (feature.properties.entity === "Santa Ana Golf Club") {
                        return {
                            clickable: true,
                            weight: 2,
                            color: '#A73BC8',
                            fill: true,
                            fillOpacity: 0.5,
                        };
                    };
		    if (feature.properties.entity === "Southern Sandoval Investments") {
                        return {
                            clickable: true,
                            weight: 2,
                            color: '#FF7F00',
                            fill: true,
                            fillOpacity: 0.5,
                        };
                    };
		    if (feature.properties.entity === "Twin Warriors") {
                        return {
                            clickable: true,
                            weight: 2,
                            color: '#DB5373',
                            fill: true,
                            fillOpacity: 0.5,
                        };
                    };
                },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<strong>Name:&nbsp;</strong>" + feature.properties.entity.toString() + "<br>" +
                "<strong>Area:&nbsp;</strong>" + (feature.properties.acres.toString()*0.404686).toFixed(2) + "&nbsp;ha<br>" +
                "<b>Total soil organic carbon:&nbsp;~</b>" + feature.properties.soctotal.toString() + "&nbsp;Mg<br>" +
                "<b>Mean soil organic carbon:&nbsp;~</b>" + feature.properties.socmean.toString() + "&nbsp;Mg/ha<br>"

            );
        }
    });


    var watersheds = new L.GeoJSON.AJAX("{% url 'watersheds' %}", {
        style: {color: '#99BADD',
                weight: 2,
                dashArray: 1,
                opacity: 0.5,
                clickable: true,
               },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<strong>Watershed:&nbsp;</strong>" + feature.properties.hu_8_name.toString()
            );
        },
    });

    var subwatersheds = new L.GeoJSON.AJAX("{% url 'subwatersheds' %}", {
        style: {color: '#3939b8',
                weight: 2,
                dashArray: 1,
                opacity: 1,
                clickable: false,
               },
        onEachFeature: function(feature, layer) {
            layer.bindPopup(
                "<b>Watershed:&nbsp;</b>" + feature.properties.watershed.toString() +
                "</br><b>Subwatershed ID: &nbsp; </b>" + feature.properties.subwatshed.toString()
            );
        },
    });

    var surfacehydro = new L.GeoJSON.AJAX("{% url 'surfacehydro' %}", {
        style: {color: '#000080',
                weight: 2,
                dashArray: 1,
                opacity: 0.7,
                clickable: false,
               },
    });

    var soil_dat;
    get_soil_dat = $.get("{% url 'soil_data' %}", function(json) {
        soil_dat = json
    });

    var bulkDens, composting, org_matter, soil_ph, taxonomy, texture;
    $.when(get_soil_dat).then(function() {
        bulkDens = new L.GeoJSON(soil_dat, {
            style: function(feature) {
            	    switch (true) {
                            case (feature.properties.bulk_densi <= 1.3):
                                return {color: "#ffffff", fillColor: "#E3CE9F", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case (feature.properties.bulk_densi > 1.3 && feature.properties.bulk_densi <= 1.4):
                                return {color: "#ffffff", fillColor: "#C5AB71", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case (feature.properties.bulk_densi > 1.4 && feature.properties.bulk_densi <= 1.5):
                                return {color: "#ffffff", fillColor: "#B6995A", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case (feature.properties.bulk_densi > 1.5 && feature.properties.bulk_densi <= 1.6):
                                return {color: "#ffffff", fillColor: "#A07F38", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case (feature.properties.bulk_densi > 1.6):
                                return {color: "#ffffff", fillColor: "#825C0B", fill: true, fillOpacity: 0.8, weight: 0.8};
            		}
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Bulk density:&nbsp;</strong>" + feature.properties.bulk_densi + "&nbsp;g/cm" + "3".sup() +
                    "<br><strong>Soil taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

        composting = new L.GeoJSON(soil_dat, {
            style: function(feature) {
                        switch (feature.properties.composting) {
                            case 'Poor': return {color: "#ffffff", fillColor: "#BC3812", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case 'Fair': return {color: "#ffffff", fillColor: "#553ADB", fill: true, fillOpacity: 0.8, weight: 0.8};
                            case 'Good': return {color: "#ffffff", fillColor: '#08794E', fill: true, fillOpacity: 0.8, weight: 0.8};
                            case 'Not rated': return {color: "#ffffff", fillColor: '#B2C7EE', fill: true, fillOpacity: 0.8, weight: 0.8};
                            }
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Composting cover:&nbsp;</strong>" + feature.properties.composting +
                    "<br><strong>Soil taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

        org_matter = new L.GeoJSON(soil_dat, {
            style: function(feature) {
                       switch (true) {
                           case (feature.properties.org_matter > 1.5):
                               return {color: "#ffffff", fillColor: '#397D02', fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.org_matter > 1.25 && feature.properties.org_matter <= 1.5):
                               return {color: "#ffffff", fillColor: "#567E3A", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.org_matter > 1.00 && feature.properties.org_matter <= 1.25):
                               return {color: "#ffffff", fillColor: "#61B329", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.org_matter > 0.75 && feature.properties.org_matter <= 1.00):
                               return {color: "#ffffff", fillColor: "#A6D785", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.org_matter > 0.5 && feature.properties.org_matter <= 0.75):
                               return {color: "#ffffff", fillColor: "#8AA37B", fill: true, fillOpacity: 0.8, weight: 0.8};
                           default:
                               return {color: "#ffffff", fillColor: "#687E5A", fill: true, fillOpacity: 0.8, weight: 0.8};
                       }
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Organic matter:&nbsp;</strong>" + feature.properties.org_matter + "%" +
                    "<br><strong>Soil taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

        soil_ph = new L.GeoJSON(soil_dat, {
            style: function(feature) {
            	    switch (feature.properties.ph_water) {
            		case 7: return {color: "#ffffff", fillColor: "#d7191c", fillOpacity: 0.8, weight: 0.8};
            		case 7.1: return {color: "#ffffff", fillColor: "#e65437", fillOpacity: 0.8, weight: 0.8};
            		case 7.3: return {color: "#ffffff", fillColor: '#f59053', fillOpacity: 0.8, weight: 0.8};
            		case 7.5: return {color: "#ffffff", fillColor: '#fdbe73', fillOpacity: 0.8, weight: 0.8};
            		case 7.6: return {color: "#ffffff", fillColor: '#fede99', fillOpacity: 0.8, weight: 0.8};
            		case 7.7: return {color: "#ffffff", fillColor: '#ffffbf', fillOpacity: 0.8, weight: 0.8};
            		case 7.8: return {color: "#ffffff", fillColor: '#ddf1bf', fillOpacity: 0.8, weight: 0.8};
            		case 7.9: return {color: "#ffffff", fillColor: '#bbe3a9', fillOpacity: 0.8, weight: 0.8};
            		case 8.0: return {color: "#ffffff", fillColor: '#91cba8', fillOpacity: 0.8, weight: 0.8};
            		case 8.1: return {color: "#ffffff", fillColor: '#5ea781', fillOpacity: 0.8, weight: 0.8};
                        }
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Soil pH:&nbsp;</strong>" + feature.properties.ph_water +
                    "<br><strong>Soil taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

        taxonomy = new L.GeoJSON(soil_dat, {
            style: function(feature) {
                       switch (true) {
                           case (feature.properties.tax_class.includes("Calciorthids")):
                               return {color: "#ffffff", fillColor: "#d12ea1", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Haplargids")):
                               return {color: "#ffffff", fillColor: "#3a2466", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Haplustalfs")):
                               return {color: "#ffffff", fillColor: "#1c1ed1", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Torrifluvents")):
                               return {color: "#ffffff", fillColor: "#a17153", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Torriorthents")):
                               return {color: "#ffffff", fillColor: "#f17369", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Torripsamments")):
                               return {color: "#ffffff", fillColor: "#55360c", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Ustifluvents")):
                               return {color: "#ffffff", fillColor: "#7f4a21", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Ustipsamments")):
                               return {color: "#ffffff", fillColor: "#58f171", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.tax_class.includes("Ustorthents")):
                               return {color: "#ffffff", fillColor: "#7c607c", fill: true, fillOpacity: 0.8, weight: 0.8};
                           default:
                               return {color: "#ffffff", fillColor: "#ffffff", fill: true, fillOpacity: 0.8, weight: 0.8};
                       }
                   },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

        texture = new L.GeoJSON(soil_dat, {
            style: function(feature) {
                        switch (true) {
                           case (feature.properties.texture.toLowerCase().includes("clay loam")):
                               return {color: "#ffffff", fillColor: "#CCCC00", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("cobbly loam")):
                               return {color: "#ffffff", fillColor: "#999900", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("fine sand")):
                               return {color: "#ffffff", fillColor: "#ffd700", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("loam")):
                               return {color: "#ffffff", fillColor: "#FFFF00", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("loamy sand")):
                               return {color: "#ffffff", fillColor: "#ffa500", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("sand")):
                               return {color: "#ffffff", fillColor: "#ff8c00", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("sandy loam")):
                               return {color: "#ffffff", fillColor: "#FFFF66", fill: true, fillOpacity: 0.8, weight: 0.8};
                           case (feature.properties.texture.toLowerCase().includes("stony loam")):
                               return {color: "#ffffff", fillColor: "#666600", fill: true, fillOpacity: 0.8, weight: 0.8};

                           default:
                               return {color: "#ffffff", fillColor: "#ffffff", fill: true, fillOpacity: 0.8, weight: 0.8};
                        }
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(
                    "<strong>Feature ID:&nbsp;</strong>" + feature.properties.poly_id +
                    "<br><strong>Soil texture:&nbsp;</strong>" + feature.properties.texture +
                    "<br><strong>Soil taxonomic class:&nbsp;</strong>" + feature.properties.tax_class, {
                    closeButton: false
                });
            },
        });

    });


////////////////////////////
////// Raster Layers ///////
////////////////////////////

    var agc = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_agc',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF'
    });

    var bgc = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_bgc',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF'
    });

    var gssurgoSOC = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_gssurgo_soc',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF'
    });

    var landfireEVT = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_evt',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF',
        clickable: true
    });

    var ndvi2005 = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_ndvi_2005',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF',
        clickable: true
    });

    var ndvi2010 = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_ndvi_2010',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF',
        clickable: true
    });

    var ndvi2015 = new L.tileLayer.wms('http://198.167.239.16:8081/geoserver/iltf/wms?', {
        service: 'WMS',
        version: '1.1.1',
        request: 'GetMap',
        format: 'image/png',
        layers: 'iltf:tamaya_ndvi_2015',
        transparent: true,
        tiled: true,
        zIndex: 10,
        bgcolor: '#FFFFFF',
        clickable: true
    });

////////////////////////////
////// Leaflet Map /////////
////////////////////////////

    var map = L.map("map", {
        zoom: 11,
        center: [35.435, -106.58],
        minZoom: 6,
        maxZoom: 20,
        layers: [esriWorld, boundary]
    });

    var lyrs;
    var legPopup = L.popup();
    var lyrs_arr = [];

///////////////////////////////////////
////// Add Leaflet-Draw controls //////
///////////////////////////////////////

    // Initialize the FeatureGroup to store editable layers

    var drawnItems = new L.FeatureGroup();

    map.addLayer(drawnItems);

    map.on('draw:drawstart', function(e) {
        legCheck = false;
    });


    // Specify some custom options for the Drawing tools

    var drawOptionsFull = {
          draw: {
            polygon: {showArea: true},
            circle: false,
            marker: false,
            polyline: false
          },
          edit: {
            featureGroup: drawnItems
          }
        }

    var drawOptionsEditOnly = {
          edit: {
            featureGroup: drawnItems
          },
          draw: false
    };


    // Initialize the draw control and pass it the FeatureGroup of editable layers
    var drawControlFull = new L.Control.Draw(drawOptionsFull);
    var drawControlEditOnly = new L.Control.Draw(drawOptionsEditOnly);
    var layerGeom = {};
    var legCheck = true;

    map.addControl(drawControlFull);

    map.on('draw:created', function (e) {
        var layer = e.layer;
        drawnItems.addLayer(layer);
        drawControlFull.remove(map);
        drawControlEditOnly.addTo(map);
        legCheck = false;

    });

    map.on('draw:deleted', function(e) {
        if (drawnItems.getLayers().length === 0) {
            drawControlEditOnly.remove(map);
            drawControlFull.addTo(map);
            legCheck = true;
        };
    });

/////////////////////////////////////////////////////////
//// Add north arrow, scale, and easy print function ////
/////////////////////////////////////////////////////////

    L.control.scale().addTo(map);
    L.easyPrint().addTo(map);

    var north = L.control({position: "bottomright"});
    north.onAdd = function(map) {
        var div = L.DomUtil.create("div", "info legend");
        div.innerHTML = '<img src="{% static '/img/north_arrow.png' %}" height="40" width="40">';
        return div;
    }
    north.addTo(map);

////////////////////////////
////// Upload Layers ///////
////////////////////////////

    var uploaded_layers = $('#downloads_uploads').children();
    var num_layers = uploaded_layers.length;
    var tmp_url = null;

    for ( var i = 0; i < num_layers; i++ ) {
        try {
            tmp_url = uploaded_layers[i].children[1].value;
        } catch ( err ) {
            tmp_url = null;
        }
    }

    function uploader() {

        var x = document.getElementById( "upload_file" );
        var txt = " ";
        var file;
        var checkerr = false;

        if ( "files" in x ) {
            if ( x.files.length == 0 ) {
                txt = "<br>Select one or more files.<br>";
            } else {
                txt += "<hr><h5>File Breakdown</h5><br>";
                file = x.files[0];
                checkerr = true;

                if ( "name" in file ) {
                    txt += "<b>File Name: </b>" + file.name + "<br>";
                }

                if ( "size" in file ) {
                    txt += "<b>File Size: </b>" + file.size + " bytes <br>";
                }

                if ( "lastModifiedDate" in file ) {
                    txt += "<b>File Last Modified: </b><br>" + file.lastModifiedDate + "<br>";
                }
            }
        } else {
            if ( x.value == "" ) {
                txt += "Select a GeoJSON or SHP file to upload.";
            } else {
                txt += "<b>The files property is not supported by your browser!</b><hr>";
                txt += "<b>File path: </b>" + x.value;
            }
        }
        document.getElementById("show_upload").innerHTML = txt;

        if ( checkerr ) {
            document.getElementById("send_upload").style.display = "block";
        } else {
            document.getElementById("send_upload").style.display = "none";
        }
    }

//////////////////////////////////////////
/////// Render User Uploaded Layers //////
//////////////////////////////////////////

    function show_static( uploadedLayer ) {
    
        var lyr = document.getElementById( uploadedLayer ).value;
        var usr_lyr = new L.geoJSON();
        var data = {'layer': lyr, csrfmiddlewaretoken: '{{csrf_token }}'};
    
        $("input[type='checkbox'][id='" + lyr + "']").change(function () {
    
            if (this.checked) {

                legCheck = false;
    
                var updateUsrLyr = $.post('{% url 'render_geojson' %}', data, function(resp) {
                    var geojson_lyr = JSON.parse(resp.layer_json);
                    usr_lyr.addData(geojson_lyr);
                });
    
                $.when(updateUsrLyr).then(function() { map.addLayer(usr_lyr);} );
               
                usr_lyr.on('click', function(e) { 
                    var usr_lyr = e.layer;
                    var centroid = usr_lyr.getBounds().getCenter();
                    var lyrGeoJSON = usr_lyr.toGeoJSON();
                    var lyrGeom = JSON.stringify(lyrGeoJSON.geometry);
                    var c_lyrs = $("div#carbon-layers input[type='checkbox']:checked").map(function() {return this.id;});
                    var c_arr = $.map(c_lyrs, function(value, index) { return [value]; });
                    var usrPopup = L.popup();
                    var usrResp;
                    
                    data = {'geom': lyrGeom, csrfmiddlewaretoken: '{{ csrf_token }}'};
    
                    var usrPost = $.post('{% url 'sumstats' %}', data, function(resp) { usrResp = resp; });
    
                    $.when(usrPost).then(function() {
                        var arr = [];
                        for(var key in c_arr) {
                            var forestArea = '<b>&nbsp&nbspForest area selected: </b>' + usrResp.forestArea + ' ha</br>';
                            arr.push(forestArea); 
                            arr.push(usrResp.text[c_arr[key]]); 
                        };
                        var arr_string = arr.join('');
    
                        if(usrResp.totalArea < 62.5) {
                            var areaFlag = '</br><b>&nbsp&nbspNote:</b> The queried polygon area is small relative to the resolution of the forest carbon pixels. Valid biomass forest carbon estimates cannot be provided. The soil organic carbon results may still be valid. </br>';
                            if($.inArray('gssurgoSOC', c_arr) > -1) {
                                if(Object.keys(c_arr).length > 1) {
                                    var arr_string = areaFlag.concat(usrResp.text['gssurgoSOC']);
                                } else {
                                    var arr_string = usrResp.text['gssurgoSOC'];
                                };
                            } else {
                                var arr_string = areaFlag;
                            };
                        };
    
                        usrPopup
                            .setLatLng(centroid)
                            .setContent('<p><b>SUMMARY STATISTICS: </b>' +
                                        '</br><b>&nbsp&nbspArea selected: </b>' + usrResp.totalArea + ' ha</br>' +
                                        arr_string + "</p>")
    
                        setTimeout(function() {
                            if(Object.keys(c_arr).length > 0) {    
                                usrPopup .openOn(map);
                            }
                        }, 250);
                    });
                });
    
            } else if ($("input[type='checkbox'][id='" + lyr + "']").prop("checked") != true) {
                legCheck = true;
                map.removeLayer(usr_lyr);
                usr_lyr = L.geoJSON();
                $("input[type='checkbox'][id='" + lyr + "']").unbind('change');
            };
        });
    };

////////////////////////////////////
//// Build legend functionality ////
////////////////////////////////////

var lyrs;
var legPopup = L.popup();
var lyrs_arr = [];

    $("div#vegetation-layers input[type='checkbox'], div#carbon-layers input[type='checkbox']").change(function () {
        lyrs = $("div#vegetation-layers input:checkbox:checked, div#carbon-layers input:checkbox:checked").map(function() {return this.id});
        legendFunction(lyrs);
    });

    function legendFunction( lyrs ) {
        if ($("div#vegetation-layers input[type='checkbox'], div#carbon-layers input[type='checkbox']").is(':checked')) {

            var legPopup = L.popup();
            lyrs_arr = [];
            for(i = 0; i < lyrs.length; i++) {
                lyrs_arr[i] = lyrs[i];
            };

            buff_bndry.addTo(map);

            map.off('click');

            map.on('click', function(e) {
                if(legCheck) {
                    var lng = e.latlng.lng;
                    var lat = e.latlng.lat;
                    updateLatLng(lat, lng, lyrs_arr);
                };
            });

        } else {
            if(map) {
                map.closePopup();
                buff_bndry.remove();
                map.off('click');
            };
        };

    };

    function updateLatLng(lat, lng, leg_lyrs) {
        var legendResp;
        var data = {'lat': lat, 'lng': lng, csrfmiddlewaretoken: '{{ csrf_token }}'};

        var legendPost = $.post('{% url 'legend' %}', data, function(resp) { legendResp = resp });

        $.when(legendPost).then(function() {
            var text = legendResp.legText
            var arr = [];
            for(var key in leg_lyrs) { arr.push(text[leg_lyrs[key]]); };
            var arr_string = arr.join('');

            legPopup
                .setLatLng([lat, lng])
                .setContent("<p><b>VEGETATION LAYERS LEGENDS: </b></br></br>" + arr_string + "</p>")

            setTimeout(function() {
                legPopup.openOn(map);
            }, 250);
        });
    };


////////////////////////////////////
////// Summary Stats Function //////
////////////////////////////////////

    drawnItems.on("click", function(e) {
        var layer = e.layer;
        var type = layer.toGeoJSON().geometry.type;
    
        if (type === 'Polygon') {
            var centroid = layer.getBounds().getCenter();
            var layerGeoJSON = layer.toGeoJSON();
            var layerGeom = JSON.stringify(layerGeoJSON.geometry);
            var queryPopup = L.popup(); 
            var c_lyrs = $("div#carbon-layers input[type='checkbox']:checked").map(function() {return this.id;});
            var c_arr = $.map(c_lyrs, function(value, index) { return [value]; });
            var post_resp;
    
            data = {'geom': layerGeom, csrfmiddlewaretoken: '{{ csrf_token }}'};
    
            var sumstatsPost = $.post('{% url 'sumstats' %}', data, function(resp) { post_resp = resp; });
    
            $.when(sumstatsPost).then(function(args) {
                var arr = [];
                for(var key in c_arr) { 
                    var forestArea = '<b>&nbsp&nbspForest area selected: </b>' + '~' + post_resp.forestArea + ' ha</br>';
                    arr.push(forestArea); 
                    arr.push(post_resp.text[c_arr[key]]); 
                };
                var arr_string = arr.join('');
    
                if(post_resp.totalArea < 62.5) {
                    var areaFlag = '</br><b>&nbsp&nbspNote:</b> The queried polygon area is small relative to the resolution of the forest carbon pixels. Valid biomass forest carbon estimates cannot be provided. The soil organic carbon results may still be valid. </br>';
                    if($.inArray('gssurgoSOC', c_arr) > -1) {
                        if(Object.keys(c_arr).length > 1) {
                            var arr_string = areaFlag.concat(statsText['gssurgoSOC']);
                        } else {
                            var arr_string = statsText['gssurgoSOC'];
                        };
                    } else {
                        var arr_string = areaFlag;
                    };
                };
    
                queryPopup
                    .setLatLng(centroid)
                    .setContent('<p><b>SUMMARY STATISTICS: </b>' +
                                '</br><b>&nbsp&nbspArea selected: </b>' + post_resp.totalArea + ' ha</br>' +
                                arr_string + "</p>")
    
                setTimeout(function() {
                    if(Object.keys(c_arr).length > 0) {    
                        queryPopup.openOn(map);
                    };
                }, 250);
            });    
        };
    });


</script>

{% endblock layers %}
