{% load leaflet_tags %}
{% load geojson_tags %}
<!DOCTYPE html>
<html>
    <head>
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/font-awesome-4.7.0/css/font-awesome.min.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-3.0.1.min.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'lib/leaflet-0.7.1/leaflet.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/MarkerCluster.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'lib/typeahead.js/typeahead.js-bootstrap.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'dist/leaflet.draw.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'lib/opacity/Control.Opacity.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'lib/jquery/jquery-ui-1.10.3.custom.min.css' %}">
        <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    </head>
    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle btn" data-toggle="collapse" data-target=".navbar-collapse" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i class="fa fa-ellipsis-v" style="color: white"></i></button>
                <button id="toggle" type="button" class="navbar-toggle btn" style="height: 34px; padding: 5px 10px; margin-right: 10px;"><i id="toggleIcon" class="fa fa-check-square-o" style="color: white"></i></button>
                <a class="navbar-brand" href="http://www.tamaya-nsn.gov/index.html" target="_blank_">Pueblo of Santa Ana</a>
            </div>
            <div class="navbar-collapse collapse" id="navbar-collapse">
                <ul class="nav navbar-nav pull-left">
                    <a class="navbar-brand" href="#" style="font-size: 0.75m; color: gray;" >Land & Natural Assets Map</a>
                </ul>
                <!--<form class="navbar-form navbar-right">
                    <div class="input-group search-container">
                        <input id="searchbox" type="text" class="form-control" placeholder="Habitat Leases Search">
                        <span class="input-group-addon"><i class="fa fa-search"></i></span>
                    </div>
                </form>-->
            </div>
        </div>
        <div class="row" id="container">
            <div class="col-sm-3 col-lg-3" id="sidebar" style="padding: 10px; overflow: auto;">
                <ul class="nav nav-tabs" id="myTab">
                    <li class="active"><a href="#layers" data-toggle="tab"><i class="fa fa-check-square-o"></i>&nbsp;Layers</a></li>
		    <li><a href="#legend" data-toggle="tab"><i class="fa fa-barcode"></i>&nbsp;Legends</a></li>
		    <li><a href="#download" data-toggle="tab"><i class="fa fa-download"></i>&nbsp;Data</a></li>
                </ul>

                <div class="tab-content" style="padding-top: 10px;">
                    <div class="tab-pane active" id="layers">
                        <div class="panel-group">

                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_" href="#admin-layers">
                                        Administrative Layers
                                    </a>
                                </div>
                                <div id="admin-layers" class="panel-collapse collapse in">
                                    <div class="panel-body" style="padding: 0px 15px;">
					<div class="checkbox">    
					    <label>
                                                <input type="checkbox" name="overlayLayers" id="boundary" z-index="1" checked>
                                                &nbsp Reservation boundary (approximate)			
                                            </label>
                                        </div>
					<div class="checkbox">    
					    <label>
                                                <input type="checkbox" name="overlayLayers" id="mblInt" z-index="2" checked>
                                                &nbsp Master business leases					
                                            </label>
                                        </div>
					<div class="checkbox">    
					    <label>
                                                <input type="checkbox" name="overlayLayers" id="roads" z-index="3" checked>
                                                &nbsp Reservation roads					
                                            </label>
                                        </div>
				    </div>
				</div>
                            </div> <!--Closes 'panel panel-default'-->

			    <div class="panel panel-default">
                                <div class="panel-heading">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_" href="#soil-layers">
                                        Soil Layers
                                    </a>
                                </div>
                                <div id="soil-layers" class="panel-collapse collapse in">
                                    <div class="panel-body" style="padding: 0px 15px;">
					<div class="checkbox">    
					    <label>
                                                <input type="checkbox" name="overlayLayers" id="soil_pH" z-index="3">
                                                &nbsp Soil surface pH, weighted average					
                                            </label>
                                        </div>
					<div class="checkbox">    
					    <label>                                               
                                                <input type="checkbox" name="overlayLayers" id="bulkDens" z-index="3">
                                                &nbsp Soil bulk density				
                                            </label>
                                        </div>
				    </div>
				</div>
                            </div>  

			    <!--<div class="panel panel-default">
                                <div class="panel-heading">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_" href="#veg-layers">
                                        Vegetation Layers
                                    </a>
                                </div>
                                <div id="veg-layers" class="panel-collapse collapse in">
                                    <div class="panel-body" style="padding: 0px 15px;">
					<div class="checkbox">    
					    <label>
                                                <input type="checkbox" name="overlayLayers" id="landfire" z-index="99">
                                                &nbsp Existing vegetation type, LANDFIRE					
                                            </label>
                                        </div>
				    </div>
				</div>
                            </div> --> 
							
			    <div class="panel panel-default">
                                <div class="panel-heading">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_" href="#imagery">
                                        Base Layers
                                    </a>
                                </div>
                                <div id="imagery" class="panel-collapse collapse in">
                                    <div class="panel-body" style="padding: 0px 15px;">
					<div class="radio">
					    <label>
                                                <input type="radio" name="basemapLayers" id="recent"checked>
                                                &nbsp Digital Globe imagery, no roads				
                                            </label>
                                        </div>
                                        <div class="radio">
					    <label>
                                                <input type="radio" name="basemapLayers" id="hybrid">
                                                &nbsp Digital Globe imagery, with roads				
                                            </label>
                                        </div>
					<div class="radio">    
					    <label>
                                                <input type="radio" name="basemapLayers" id="topo">
                                                &nbsp Topography, ESRI
                                            </label>
                                        </div>                                     
				    </div> 
			        </div>
			    </div> <!--Closes 'panel panel-default'-->
			 </br>

			</div>  <!--Closes 'panel group'-->
                    </div> <!--Closes id='layers'-->

		    <div class="tab-pane" id="legend">
		      <div class="panel-group">

			  <h4><strong>Vegetation:</strong></h4>
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_" href="#landfire-labels">
                                        Existing Vegetation Type, LANDFIRE:
                                    </a>
                                </div>
                                <div id="landfire-labels" class="panel-collapse collapse in">
                                    <div class="panel-body" style="padding: 15px 15px;">
				      <div>
					<p>The legend items are arranged in order of existing vegetation type of greatest total coverage within the reservation to least total coverage. The hectares (ha) of coverage as well as the percent of the total reservation area covered are given for each vegetation type in the parentheses. Official documentation on LANDFIRE's Existing Vegetation Type (EVT) data can be found <a href=http://www.landfire.gov/NationalProductDescriptions21.php>here</a>.</p>
			</br>
					<div class="color-box" style="background-color:#FFE987"></div><div class="legLab">&nbsp Sandy Plains Semi-Desert Grassland (13,885.6 ha; 35.24%)</div>
					<div class="color-box" style="background-color:#826548"></div><div class="legLab">&nbsp Big Sagebrush Shrubland (13,820.5 ha; 35.07%)</div>
					<div class="color-box" style="background-color:#967B59"></div><div class="legLab">&nbsp Stabilized Coppice Dune and Sand Flat Scrub (6,310.7 ha; 16.01%)</div>
					<div class="color-box" style="background-color:#FFCC33"></div><div class="legLab">&nbsp Semi-Desert Shrubland (6,244.6 ha; 15.85%)</div>
					<div class="color-box" style="background-color:#4A2C1D"></div><div class="legLab">&nbsp Mixed Desert and Thornscrub (3,134.1 ha; 7.95%)</div>
					<div class="color-box" style="background-color:#79FF5E"></div><div class="legLab">&nbsp Pinyon-Juniper Woodland (1,816 ha; 4.61%)</div>
					<div class="color-box" style="background-color:#593B28"></div><div class="legLab">&nbsp Mogolland Chaparral (1,620.9 ha; 4.11%)</div>
					<div class="color-box" style="background-color:#0000FF"></div><div class="legLab">&nbsp Open Water (700.4 ha; 1.78%)</div>
					<div class="color-box" style="background-color:#9EAAD7"></div><div class="legLab">&nbsp Western Cool Temperate Developed Ruderal Shrubland (487.1 ha; 1.24%)</div>
					<div class="color-box" style="background-color:#AB916A"></div><div class="legLab">&nbsp Montane-Subalpine Grassland (404.8 ha; 1.03%)</div>
					<div class="color-box" style="background-color:#CA7AF5"></div><div class="legLab">&nbsp Western Cool Temperate Urban Herbaceous (355.2 ha; 0.90%)</div>
					<div class="color-box" style="background-color:#49ABBA"></div><div class="legLab">&nbsp Montane Riparian Forest and Woodland (306.0 ha; 0.78%)</div>
					<div class="color-box" style="background-color:#E3D41C"></div><div class="legLab">&nbsp Western Cool Temperate Pasture and Hayland (243.5 ha; 0.62%)</div>
					<div class="color-box" style="background-color:#FF8E42"></div><div class="legLab">&nbsp Shortgrass Prairie (239.3 ha; 0.61%)</div>
					<div class="color-box" style="background-color:#A18660"></div><div class="legLab">&nbsp Creosotebush Desert Scrub (238.4 ha; 0.60%)</div>
					<div class="color-box" style="background-color:#BFBFBF"></div><div class="legLab">&nbsp Barren (198.5 ha; 0.50%)</div>
					<div class="color-box" style="background-color:#FFFFFF"></div><div class="legLab">&nbsp Developed-Roads (209.5 ha; 0.53%)</div>
					<div class="color-box" style="background-color:#B86018"></div><div class="legLab">&nbsp Wetland-Herbaceous (164.2 ha; 0.42%)</div>
					<div class="color-box" style="background-color:#CFABD7"></div><div class="legLab">&nbsp Western Cool Temperate Urban Shrubland (158.8 ha; 0.40%)</div>
					<div class="color-box" style="background-color:#FF692E"></div><div class="legLab">&nbsp Introduced Upland Vegetation-Annual Grassland (128.2; 0.33%)</div>
					<div class="color-box" style="background-color:#4EFF3B"></div><div class="legLab">&nbsp Mixed Desert and Thornscrub (126.5 ha; 0.32%)</div>
					<div class="color-box" style="background-color:#F5AF36"></div><div class="legLab">&nbsp Gambel Oak-Mixed Montane Shrubland (124.9 ha; 0.32%)</div>
					<div class="color-box" style="background-color:#51B48D"></div><div class="legLab">&nbsp Warm Desert Riparian Forest and Woodland (99.3 ha; 0.25%)</div>
					<div class="color-box" style="background-color:#646464"></div><div class="legLab">&nbsp Warm Desert Sparsely Vegetated Systems II (99.0 ha; 0.25%)</div>
					<div class="color-box" style="background-color:#FFED77"></div><div class="legLab">&nbsp Western Cool Temperate Close Grown Crop (93.7 ha; 0.24%)</div>
					<div class="color-box" style="background-color:#FF7A8F"></div><div class="legLab">&nbsp Developed-Low Intensity (85.7 ha; 0.22%)</div>
					<div class="color-box" style="background-color:#7A8EF5"></div><div class="legLab">&nbsp Western Cool Temperate Developed Ruderal Grassland (61.5 ha; 0.16%)</div>
					<div class="color-box" style="background-color:#D6FFB5"></div><div class="legLab">&nbsp Ponderosa Pine Woodland (52.1 ha; 0.13%)</div>
					<div class="color-box" style="background-color:#FD2C4F"></div><div class="legLab">&nbsp Developed-Medium Intensity (49.0 ha; 0.12%)</div>
					<div class="color-box" style="background-color:#FFC87D"></div><div class="legLab">&nbsp Semi-Desert Grassland (35.4 ha; 0.09%)</div>
					<div class="color-box" style="background-color:#9C805C"></div><div class="legLab">&nbsp Mixed Salt Desert Scrub (25.0 ha; 0.06%)</div>
					<div class="color-box" style="background-color:#003300"></div><div class="legLab">&nbsp Dry-Mesic Montane Mixed Conifer Forest and Woodland (21.6 ha; 0.05%)</div>
					<div class="color-box" style="background-color:#6677CD"></div><div class="legLab">&nbsp Western Cool Temperate Developed Ruderal Evergreen Forest (20.1 ha; 0.05%)</div>
					<div class="color-box" style="background-color:#917554"></div><div class="legLab">&nbsp Juniper Savanna (17.5 ha; 0.04%)</div>
					<div class="color-box" style="background-color:#C29ED7"></div><div class="legLab">&nbsp Western Cool Temperate Urban Mixed Forest (9.4 ha; 0.02%)</div>
					<div class="color-box" style="background-color:#704489"></div><div class="legLab">&nbsp Western Cool Temperate Urban Deciduous Forest (8.2 ha; 0.02%)</div>
					<div class="color-box" style="background-color:#AA66CD"></div><div class="legLab">&nbsp Western Cool Temperate Urban Evergreen Forest (6.1 ha; 0.02%)</div>
					<div class="color-box" style="background-color:#AD001C"></div><div class="legLab">&nbsp Developed-High Intensity (4.0 ha; 0.01%)</div>
					<div class="color-box" style="background-color:#403DA8"></div><div class="legLab">&nbsp Western Cool Temperate Developed Ruderal Deciduous Forest (0.7 ha; 0.00%)</div>
					<div class="color-box" style="background-color:#FAFF77"></div><div class="legLab">&nbsp Western Cool Temperate Row Crop (0.4 ha; 0.00%)</div>
				      </div>
				    </div>
				</div>
			    </div>

			    </br>

			</div> <!--Closes 'panel-group'-->
                    </div> <!--Closes tab-pane="legend"-->  

		    <div class="tab-pane" id="download">
			<h3>Download Data Layers:</h3>
			    <p> The data layers displayed on this webmap can be downloaded for use in desktop GIS software here.</p>
			    </br>
			    <!--<h4><strong>Soil layers</strong></h4>
			        <ul>
                    		    <li><a href="./downloads/ph_surface_weighted_average.zip">Soil surface pH, weighted average</a></li>
				    <li><a href="./downloads/bulk_density_1_3_bar.zip">Soil bulk density</a></li>
				    <li><a href="./downloads/organic_matter.zip">Organic matter</a></li>
				    <li><a href="./downloads/soil_taxonomy.zip">Soil taxonomic classification</a></li>
				    <li><a href="./downloads/surface_texture_dcp.zip">Surface soil texture</a></li>
				    <li><a href="./downloads/composting_medium_and_final_cover.zip">Compost</a></li>
				</ul>
			    <h4><strong>Vegetation layers</strong></h4>
			        <ul>
                    		    <li><a href="./downloads/landfire-evt-tamaya.tif">Existing vegetation type, LANDFIRE</a></li>
				</ul>-->
			    </br>
			    </br>
                                          
                     </div> <!--Closes tab-pane="download"-->

                </div> <!--Closes 'tab-content'-->
            </div> <!--Closes ID="sidebar"-->

        <div class="col-sm-9 col-lg-9" id="map">
           <!-- <div id="loading" style="display: block;">
                    <div class="loading-indicator">
                        <div class="progress progress-striped active">
                            <div class="progress-bar progress-bar-info" style="width: 100%"></div>
                        </div>
                    </div>
                </div>-->
        </div>

        </div> <!--Closes ID="container"-->

        <script type="text/javascript" src="{% static 'lib/leaflet-0.7.1/leaflet.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/jquery-2.0.3.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/bootstrap-3.0.1.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/d3.v3/d3.v3.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/ajax_leaflet/leaflet.ajax.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'assets/typeahead.js/typeahead.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/leaflet.markercluster.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/colorbrewer/colorbrewer.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/Leaflet.draw.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/edit/handler/Edit.Poly.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/Edit.SimpleShape.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/Edit.Circle.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/Edit.Rectangle.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/Edit.Marker.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Feature.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Polyline.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Polygon.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.SimpleShape.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Rectangle.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Circle.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/draw/handler/Draw.Marker.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/ext/TouchEvents.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/ext/LatLngUtil.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/ext/GeometryUtil.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/ext/LineUtil.Intersect.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/ext/Polyline.Intersect.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/ext/Polygon.Intersect.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/Control.Draw.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/Tooltip.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/Toolbar.js' %}"></script>

        <script type="text/javascript" src="{% static 'js/src/draw/DrawToolbar.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/EditToolbar.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/EditToolbar.Edit.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/src/edit/handler/EditToolbar.Delete.js' %}"></script>

        <script type="text/javascript" src="{% static 'lib/opacity/Control.Opacity.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/jquery/jquery-1.9.1.js' %}"></script>
        <script type="text/javascript" src="{% static 'lib/jquery/jquery-ui-1.10.3.custom.min.js' %}"></script>

        <script type="text/javascript">


            var map, parcelSearch = [];

            $(document).ready(function() {
                $("[rel=tooltip]").tooltip();
                if (document.body.clientWidth <= 767) {
                    $("#map").css("class", "col-sm-12 col-lg-12");
                    $("#sidebar").css("display", "none");
                };
            });

            $(window).resize(function() {
                $(".tt-dropdown-menu").css("max-height", $("#container").height()-$(".navbar").height()-20);
                if (document.body.clientWidth <= 767) {
                    $("#map").css("class", "col-sm-12 col-lg-12");
                    $("#sidebar").css("display", "none");
                } else {
                    $("#map").css("class", "col-sm-9 col-lg-9");
                    $("#sidebar").css("display", "block");
                };
            });

            $("#toggle").click(function() {
                $("#toggle i").toggleClass("fa fa-check-square-o fa fa-map-marker");
                $("#map").toggleClass("col-sm-9 col-lg-9 col-sm-12 col-lg-12");
                $("#sidebar").toggle();
                if (document.body.clientWidth <= 767) {
                    $("#map").toggle();
                };
                map.invalidateSize();
                return false;
            });
            //following script from;  https://gist.github.com/bmcbride/6186672
            $("input[name='basemapLayers']").change(function () {
                // Remove unchecked layers
                $("input:radio[name='basemapLayers']:not(:checked)").each(function () {
                    map.removeLayer(window[$(this).attr("id")]);
                });
                // Add checked layer
                $("input:radio[name='basemapLayers']:checked").each(function () {
                    map.addLayer(window[$(this).attr("id")]);
                });
            });

            $("input:checkbox[name='overlayLayers']").change(function () {
                var layers = [];
                function sortByKey(array, key) {
                    return array.sort(function (a, b) {
                        var x = a[key];
                        var y = b[key];
                        return ((x < y) ? -1 : ((x > y) ? 1 : 0));
                    });
                }
                if ($("#" + $(this).attr("id")).is(":checked")) {
                    $("input:checkbox[name='overlayLayers']").each(function () {
                        // Remove all overlay layers
                        map.removeLayer(window[$(this).attr("id")]);
                        if ($("#" + $(this).attr("id")).is(":checked")) {
                            // Add checked layers to array for sorting
                            layers.push({
                                "z-index": $(this).attr("z-index"),
                                "layer": $(this)
                            });
                        }
                    });
                    // Sort layers array by z-index
                    var orderedLayers = sortByKey(layers, "z-index");
                    // Loop through ordered layers array and add to map in correct order
                    $.each(orderedLayers, function () {
                        map.addLayer(window[$(this)[0].layer[0].id]);
                    });
                } else {
                    // Simply remove unchecked layers
                    map.removeLayer(window[$(this).attr("id")]);
                }
            });

////////////////////////////
////// Basemap Layers //////
////////////////////////////

            var api_key = 'pk.eyJ1IjoiZGlnaXRhbGdsb2JlIiwiYSI6ImNpcXE5ZjRxeDAyaHJmdm5oc20xbzVndGoifQ.jWIT7A205HVSAxKvVLeywQ';
            var hybrid = new L.tileLayer('https://{s}.tiles.mapbox.com/v4/digitalglobe.nal0mpda/{z}/{x}/{y}.png?access_token=' + api_key, {
                maxZoom: 19,
                attribution: '(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a> , (c) OpenStreetMap, (c) Mapbox'
            });
            var recent = new L.tileLayer('https://{s}.tiles.mapbox.com/v4/digitalglobe.nal0g75k/{z}/{x}/{y}.png?access_token=' + api_key, {
                maxZoom: 19,
                attribution: '(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a>'
            });
            var topo = new L.TileLayer("http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}.png", {
                maxZoom: 19,
                attribution: 'Basemap Courtesy of <a href="http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer" target="_blank">ESRI</a>'
              });
            recent.setZIndex(8);

////////////////////////////
////// Overlay Layers //////
////////////////////////////

            var boundary = new L.GeoJSON.AJAX("{% url 'boundary' %}", {
                style: { clickable: false,
                         weight: 3,
                         color: '#000000',
                         dashArray: 3,
                         opacity: 1,
                         fill: false,
                       }
            });

            /*var mbl = {{ qs_results|geojsonfeature|safe }};
            L.geoJson(mbl).addTo(map);*/

            var mblInt = new L.GeoJSON(null, {
                style: { color: '#000000',
                       }
                });
            
            $.getJSON('{% url "mbls" %}', function (data) {
                mblInt.addData(data);
            });

            /*var mblInt = new L.GeoJSON.AJAX("{% url 'mbls' %}", {
                style: { clickable: true,
                         weight: 3,
                         opacity: 0.75,
                       }
            });*/

            var roads = new L.GeoJSON(null, {
                style: {color: '#797976',
                        weight: 1.5,
                        dashArray: 1,
                        opacity: 1,
                        clickable: true,
                       }
            });

            $.getJSON('{% url "roads" %}', function (data) {
                roads.addData(data);
            });
            
            var bulkDens = new L.GeoJSON.AJAX("{% url 'bulk_density' %}", {
                style: { clickable: true,
                         weight: 1.5,
                         dashArray: 1,
                         opacity: 0.6,
                         fill: true,
                       }
            });



////////////////////////////
////// Leaflet Map /////////
////////////////////////////

            var map = L.map("map", {
                zoom: 11,
                center: [35.435, -106.54], 
                minZoom: 6,
                maxZoom: 20,
                layers: [recent, boundary, mblInt, roads]
            });

       	    // Add Leaflet-Draw controls
            // Initialize the FeatureGroup to store editable layers
	    var drawnItems = new L.FeatureGroup();
	    map.addLayer(drawnItems);

            // Specify some custom options for the Drawing tools

		var drawOptions = {
		draw: {
			polygon: {
				showArea: true
				}
		},
		edit: {
			featureGroup: drawnItems
			}
		}

		// Initialize the draw control and pass it the FeatureGroup of editable layers
		var drawControl = new L.Control.Draw(drawOptions);
		
		map.addControl(drawControl);

		map.on('draw:created', function (e) {
		var type = e.layerType,
			layer = e.layer;

		if (type === 'marker') {
			layer.bindPopup('A popup!');
		}

		// Do whatever else you need to. (save to db, add to map etc)
		drawnItems.addLayer(layer);
		});

            // Add opacity controls

            var opacitySlider = new L.Control.opacitySlider();
            map.addControl(opacitySlider);

            //opacitySlider.setOpacityLayer(landfire)



// Larger screens get expanded layer control
            if (document.body.clientWidth <= 767) {
                var isCollapsed = true;
            } else {
                var isCollapsed = false;
            };

            // Highlight search box text on click
            $("#searchbox").click(function () {
                $(this).select();
            });

            // Typeahead search functionality
            $(document).one("ajaxStop", function() {
                $("#loading").hide();
                $("#searchbox").typeahead([{
                    name: "HabitatLeases",
                    local: habitatLeasesSearch,
                    minLength: 2,
                    header: "<h4 class='typeahead-header'>HabitatLeases</h4>"
                },]).on("typeahead:selected", function (obj, datum) {
                    if (datum.layer === "HabitatLeases") {
                        map.setView([datum.lat, datum.lng], 16);
                        if (map._layers[datum.id]) {
                            map._layers[datum.id].openPopup();
                        };
                    };
                    if (datum.layer === "Boroughs") {
                        map.fitBounds(datum.bounds);
                    };
                    if (datum.layer === "Theaters") {
                        if (!map.hasLayer(theaters)) {
                            map.addLayer(theaters);
                            $("#theaters").prop("checked", true);
                        };
                        map.setView([datum.lat, datum.lng], 17);
                        if (map._layers[datum.id]) {
                            map._layers[datum.id].openPopup();
                        };
                    };
                    if (datum.layer === "Museums") {
                        if (!map.hasLayer(museums)) {
                            map.addLayer(museums);
                            $("#museums").prop("checked", true);
                        };
                        map.setView([datum.lat, datum.lng], 17);
                        if (map._layers[datum.id]) {
                            map._layers[datum.id].openPopup();
                        };
                    };
                    if (datum.layer === "GeoNames") {
                        map.setView([datum.lat, datum.lng], 14);
                    };
                    if ($("#navbar-collapse").height() > 50) {
                        $("#navbar-collapse").collapse("hide");
                    };
                }).on("typeahead:initialized ", function () {
                    $(".tt-dropdown-menu").css("max-height", 300);
                }).on("typeahead:opened", function () {
                    $(".navbar-collapse.in").css("max-height", $(document).height()-$(".navbar-header").height());
                    $(".navbar-collapse.in").css("height", $(document).height()-$(".navbar-header").height());
                }).on("typeahead:closed", function () {
                    $(".navbar-collapse.in").css("max-height", "");
                    $(".navbar-collapse.in").css("height", "");
                });
            });

            // Placeholder hack for IE
            if (navigator.appName == "Microsoft Internet Explorer") {
                $("input").each( function () {
                    if ($(this).val() == "" && $(this).attr("placeholder") != "") {
                        $(this).val($(this).attr("placeholder"));
                        $(this).focus(function () {
                            if ($(this).val() == $(this).attr("placeholder")) $(this).val("");
                        });
                        $(this).blur(function () {
                            if ($(this).val() == "") $(this).val($(this).attr("placeholder"));
                        });
                    }
                });
            }

        </script>
    </body>
</html>
